# 《灵宠放置传》代码改造工作计划

## 改造总览

| 改造项 | 涉及文件数 | 代码触点 | 难度 | 优先级 |
|-------|-----------|---------|------|-------|
| A. 双棋盘制（6珠×2套） | 4 | ~30处 | 🟠 中 | P0 |
| B. 星级扩展至4星 | 6 | ~35处 | 🟡 低 | P0 |
| C. 法宝→队长技迁移 | **17** | **265+处** | 🔴 高 | P1 |
| D. 宠物数据重做（214只+种族+9元素） | 3 | 整文件重写 | 🔴 高 | P1 |
| E. 合成配方系统 | 3 | ~50处 | 🟠 中 | P2 |
| F. 稀有度适配（已3档，基本一致） | 1 | ~5处 | 🟢 低 | P3 |

---

## Phase 1（基础框架）≈ 2-3天

### A. 双棋盘制（炎海 / 岚雷）

**现状**：固定 6 珠 `['metal','wood','earth','water','fire','heart']`，五行克制链

**改为**：根据敌人属性切换两套棋盘

| 文件 | 改动内容 | 行数估算 |
|------|---------|---------|
| `js/data/tower.js` | 新增两套 `BEAD_ATTRS`、两套 `ATTR_COLOR`、两套 `COUNTER_MAP`；修改 `getBeadWeights()` 按敌人属性选棋盘 | ~80行 |
| `js/engine/battle.js` | `initBoard()` 和 `fillBoard()` 传入当前棋盘类型；克制计算 `calcCounter()` 使用对应克制表 | ~20行 |
| `js/views/battleView.js` | 珠子渲染颜色从新的颜色表读取（草/雷/风需要新的主色值） | ~15行 |
| `js/data/tower.js` | 怪物数据增加属性字段用于棋盘选择 | ~10行 |

**关键设计**：
```
炎海棋盘: BEAD_ATTRS = ['fire','water','grass','light','shadow','heart']
岚雷棋盘: BEAD_ATTRS = ['wind','thunder','earth','light','shadow','heart']

炎海克制: fire→grass→water→fire, light↔shadow
岚雷克制: thunder→wind→earth→thunder, light↔shadow
```

### B. 星级扩展至 4 星

**现状**：`MAX_STAR=3`，等级上限 30/50/80，ATK倍率 ×1.0/×1.3/×1.69

**改为**：`MAX_STAR=4`，等级上限 30/50/80/100，ATK倍率 ×1.0/×1.3/×1.69/×2.2

| 文件 | 改动内容 | 触点 |
|------|---------|------|
| `js/data/pets.js` | `MAX_STAR=4`；`getMaxLevel()` 增加 star=4→100；新增 `STAR4_SKILL_OVERRIDE`（队长技定义）；`STAR_ATK_MUL` 调整 | ~100行新增 |
| `js/data/storage.js` | `starUpPet()` 升星消耗逻辑：3→4 需 3 只同宠 + 突破石；`addPetExp()` level cap 适配 | ~15行 |
| `js/views/petManageView.js` | 升星 UI 展示 4 星；消耗提示（3只+突破石）；★4 队长技展示 | ~30行 |
| `js/engine/skills.js` | ★4技能执行分支（复用 star3 override 模式） | ~20行 |
| `js/views/dialogs.js` | star4 庆典动画（类似 star3 庆典） | ~30行 |
| `js/runtime/music.js` | star4 解锁音效 | ~5行 |

**升星消耗**：
```
1→2 需 1 只同ID宠
2→3 需 2 只同ID宠
3→4 需 3 只同ID宠 + 突破石道具
```

---

## Phase 2（系统重构）≈ 5-7天

### C. 法宝 → 队长技迁移（工作量最大）

**现状**：独立法宝系统，17 个文件 265+ 处引用

**改为**：法宝概念删除，效果绑定到宠物★4队长技，编队第一位宠物的队长技全队生效

#### C1. 数据层改造
| 文件 | 改动 |
|------|------|
| `js/data/weapons.js` | 保留但重命名为 `captainSkills.js`，或将队长技数据合并到 `pets.js`。每只宠物★4解锁一个队长技（效果type复用现有法宝type） |
| `js/data/pets.js` | 每只宠物模板新增 `captainSkill: { type, name, desc, ... }` 字段 |
| `js/data/storage.js` | 删除 `ownedWeapons[]`、`equippedWeaponId`；`g.weapon` 改为从编队队长宠物动态获取 |

#### C2. 引擎层改造（核心）
| 文件 | 改动 | 触点 |
|------|------|------|
| `js/engine/battle.js` | 所有 `g.weapon` → `g.captainSkill`（或保留 `g.weapon` 变量名只改来源）。56处引用逻辑不变，只改数据来源 | 56 |
| `js/engine/runManager.js` | 删除 `generateStarterWeapon()`、`g.weaponBag`、`weaponReviveUsed`；开局时从队长宠物读取队长技 | 19 |
| `js/engine/skills.js` | 删除法宝奖励生成（`NEW_WEAPON` 类型）、法宝相关奇遇/商店选项 | 10 |
| `js/engine/stageManager.js` | `g.weapon = getEquippedWeapon()` → 从编队第一位宠物获取 | 4 |
| `js/engine/tutorial.js` | 删除法宝教学环节 | 8 |

#### C3. 视图层改造
| 文件 | 改动 | 触点 |
|------|------|------|
| `js/views/prepareView.js` | 删除整个法宝 Tab (`_drawWeaponTab`)，准备界面只保留宠物编队 | 26 |
| `js/views/battleView.js` | 队伍栏第一位显示"队长"标记替代法宝图标；删除法宝弹窗 | 19 |
| `js/views/eventView.js` | 删除法宝背包网格、法宝拖拽、法宝详情弹窗 | 22 |
| `js/views/screens.js` | 奖励卡片删除 `NEW_WEAPON` 类型；纪录面板删除法宝显示 | 15 |
| `js/views/dialogs.js` | 删除 `drawWeaponDetailDialog`；可新增队长技说明弹窗 | 5 |
| `js/render.js` | 删除 `drawWeaponFrame` 方法 | 1 |

#### C4. 输入/交互层
| 文件 | 改动 | 触点 |
|------|------|------|
| `js/input/touchHandlers.js` | 删除法宝拖拽逻辑、法宝详情弹窗触摸 | 35 |
| `js/main.js` | 删除 `g.weapon`, `g.weaponBag`, `g.weaponReviveUsed`, `g.prepareTab='weapon'`, `g.showWeaponDetail` 等全局状态 | 12 |

#### C5. 云端
| 文件 | 改动 |
|------|------|
| `cloudfunctions/ranking/index.js` | `weapon` 字段改为 `captainSkill` 或删除 |

**关键策略**：`battle.js` 中 56 处 `g.weapon.type === 'xxx'` 的效果逻辑完全复用，只改数据来源。最小化改动方案是保留 `g.weapon` 变量名，只在赋值处改为从队长宠物读取：
```js
// 现在：g.weapon = generateStarterWeapon() 或 g.weapon = WEAPONS.find(...)
// 改为：g.weapon = team[0]?.star >= 4 ? team[0].captainSkill : null
```

### E. 合成配方系统

**现状**：`fusePets()` 纯随机（品质加权）

**改为**：189 组固定配方 + 无配方随机兜底

| 文件 | 改动 |
|------|------|
| `js/data/pets.js` | 新增 `RECIPES = [{a:'火狐', b:'水獭', out:'雾狐'}, ...]`（189条）；`fusePets()` 先查配方表，命中则必出，未命中则走现有随机逻辑 |
| `js/data/storage.js` | `fuseTwoPets()` 调用改造后的 `fusePets()`，新增已解锁配方记录 |
| `js/views/petManageView.js` | 融合 UI 增加"已发现配方"提示（可选） |

---

## Phase 3（内容填充）≈ 5-7天

### D. 宠物数据重做（214只 + 种族 + 9元素）

**现状**：100 只宠物，5 属性(金木土水火)，无种族

**改为**：~213 只宠物，9 属性(火水草雷土风光影心)，7 种族

| 文件 | 改动 |
|------|------|
| `js/data/pets.js` | 几乎全部重写：PETS 数据结构从 `{metal:[...],wood:[...]}` 改为按种族或统一数组；每只宠物新增 `race` 字段；属性标识从 metal/wood 改为 fire/water/grass 等 |
| `js/data/tower.js` | ATTRS 从 5 种改为 9 种；ATTR_NAME/ATTR_COLOR 扩展 |
| `js/views/petManageView.js` | 筛选栏从 5 属性改为 9 属性 + 种族筛选 |

### F. 稀有度适配
现有代码已是 3 档(T1/T2/T3 = SSR/SR/R)，与方案一致。仅需将 PET_TIER 分类标准适配新的 213 只宠物。

---

## 推荐实施顺序

```
Phase 1（基础框架）  ≈ 2-3天
  ├─ A. 双棋盘制（核心战斗体验变化）
  └─ B. 星级扩展至4星

Phase 2（系统重构）  ≈ 5-7天
  ├─ C. 法宝→队长技迁移（最大工作量，265+触点）
  └─ E. 合成配方系统

Phase 3（内容填充）  ≈ 5-7天
  └─ D. 宠物数据重做（213只 + 技能设计 + 背景故事）

总计预估：12-17 天
```

> Phase 1 可以立即开始，不依赖宠物数据重做，先用现有 100 只宠物验证新机制。
